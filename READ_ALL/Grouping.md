# Group-based Trajectory Visualization

## 데이터셋 개요

본 프로젝트는 ETH-UCY 데이터셋을 기반으로 합니다. 이는 실제 세계의 보행자 궤적을 포함하는 표준 벤치마크 데이터셋입니다.

### 데이터셋 구성

1. **ETH 데이터셋**
   - 위치: ETH 대학 캠퍼스
   - 특징: 외부 보행자 이동 패턴
   - 환경: 개방된 캠퍼스 공간

2. **HOTEL 데이터셋**
   - 위치: 호텔 입구 주변
   - 특징: 입/출구 통행 패턴
   - 환경: 제한된 출입구 공간

3. **UNIV 데이터셋**
   - 위치: 대학 캠퍼스
   - 특징: 학생들의 일상적 이동
   - 환경: 캠퍼스 내 보행로

4. **ZARA 데이터셋**
   - ZARA1, ZARA2로 구분
   - 위치: 쇼핑몰 전면부
   - 특징: 쇼핑객들의 이동 패턴
   - 환경: 상업 지구 보행로

### 데이터 특성

1. **시간적 특성**
   - 샘플링 레이트: 2.5Hz
   - 프레임 간격: 0.4초
   - 연속적 궤적 추적

2. **공간적 특성**
   - 월드 좌표계 사용
   - x, y 좌표로 위치 표현
   - 단위: 미터(m)

3. **데이터 구조**
   - 보행자 ID
   - 프레임 번호
   - 위치 좌표 (x, y)
   - 궤적 시퀀스

## Overview
이 문서는 보행자 궤적 데이터에 대한 그룹 기반 시각화 구현 과정을 설명합니다. 구현은 정적 이미지와 동적 비디오 시각화를 모두 포함하며, 각 보행자의 궤적과 불확실성, 그리고 그룹 정보를 시각적으로 표현합니다.

## 데이터 구조

### 1. 입력 데이터 텐서
- **V_pred**: [B, T, N, d] 형태의 텐서
  - B: 배치 크기 (1)
  - T: 시퀀스 길이 (8 프레임)
  - N: 보행자 수 (5명)
  - d: 특성 차원 (5: 위치(2) + 불확실성(3))
    - 위치: (x, y) 좌표 [0:2]
    - log(분산): 불확실성 크기 [2]
    - 상관관계: [-1, 1] 범위의 값 [3]
    - log(축비): 불확실성 타원의 비율 [4]

### 2. 궤적 데이터
- **obs_traj**: [B, T_obs, N, 2] - 관측된 궤적
  - T_obs: 관측 시퀀스 길이 (4 프레임)
  - 각 보행자의 (x, y) 위치 좌표

- **pred_traj_gt**: [B, T_pred, N, 2] - 실제 미래 궤적
  - T_pred: 예측 시퀀스 길이 (4 프레임)
  - Ground truth 위치 좌표

### 3. 그룹 정보
- **group_indices**: [B, N] - 그룹 할당 정보
  - 각 보행자가 속한 그룹의 ID를 저장
  - 0부터 시작하는 정수로 그룹 표현

## 그룹 할당 방법

### GroupAssignment 클래스
```python
group_assignment = GroupAssignment(d_type='euclidean', th=0.5)
```

1. **거리 계산**:
   - 유클리드 거리를 사용하여 보행자 간 거리 계산
   - 전체 궤적 시퀀스에 대한 평균 거리 고려

2. **그룹화 기준**:
   - 임계값(th) = 0.5 사용
   - 두 보행자 간 거리가 임계값보다 작으면 같은 그룹으로 할당
   - 임계값이 작을수록 더 많은 그룹이 생성됨

3. **결과**:
   - v_grouped: 그룹화된 궤적 데이터
   - group_indices: 각 보행자의 그룹 할당 정보
   - dist_mat: 보행자 간 거리 행렬
   - result_dict: 전체 그룹화 결과 정보

## 시각화 구현

### 1. 정적 시각화 (data_visualizer)

```python
fig_img = data_visualizer(V_pred, obs_traj, pred_traj_gt, group_indices)
```

#### 특징:
1. **궤적 표시**:
   - 관측 궤적: 실선
   - 예측 궤적: 점선
   - 각 그룹별로 다른 색상 사용

2. **불확실성 시각화**:
   - KDE (Kernel Density Estimation) 사용
   - 각 위치에서의 예측 불확실성을 2D 분포로 표현
   - 투명도를 사용하여 겹치는 영역 표현

3. **그룹 색상**:
   - matplotlib의 'tab20' 컬러맵 사용
   - 최대 20개의 구분되는 색상 지원
   - 같은 그룹은 동일한 색상으로 표시

### 2. 동적 시각화 (create_trajectory_video)

```python
create_trajectory_video(V_pred, obs_traj, pred_traj_gt, group_indices, 
                      output_path='trajectory_video.mp4', fps=10)
```

#### 프레임 처리:
1. **시간 분할**:
   - 총 8 프레임 (관측 4 + 예측 4)
   - 각 프레임은 0.1초 간격 (10 FPS)

2. **프레임별 시각화**:
   - 현재 프레임까지의 궤적만 표시
   - 현재 위치에서의 불확실성 표시
   - 관측/예측 구간에 따라 다른 처리

3. **비디오 생성**:
   - OpenCV 사용 (mp4v 코덱)
   - RGBA to BGR 변환으로 투명도 처리
   - 프로그레스 표시 기능 포함

## 불확실성 모델링

### 1. 예측 불확실성 매개변수
- **분산(variance)**: exp(V_pred[:, 2])
  - 불확실성의 전체적인 크기 결정
  - 로그 스케일로 저장하여 안정성 확보

- **상관관계(correlation)**: tanh(V_pred[:, 3])
  - [-1, 1] 범위로 정규화
  - x, y 좌표 간의 상관관계 표현

- **축비율(axis ratio)**: exp(V_pred[:, 4])
  - 불확실성 타원의 장축/단축 비율
  - 방향성 있는 불확실성 표현

### 2. 샘플링 방법
```python
samples = 1000  # 샘플 수
n_levels = 30   # KDE 레벨 수
```

1. **다변량 정규분포 사용**:
   - 각 보행자별로 별도의 분포 생성
   - 2x2 공분산 행렬로 방향성 표현

2. **샘플링 과정**:
   - 각 보행자별 1000개 샘플 생성
   - 현재 위치 기준으로 상대 좌표 변환
   - KDE를 통한 부드러운 분포 시각화

## 캐싱 및 저장

### 1. 데이터 캐싱
- 그룹화 결과를 pickle 파일로 저장
- 파일명에 타임스탬프 포함
- `data_cache/` 디렉토리에 저장

### 2. 시각화 결과 저장
- **정적 이미지**: 'test_visualization.png'
  - 전체 궤적과 불확실성을 포함한 단일 이미지
  - 고해상도 PNG 포맷

- **동영상**: 'test_visualization.mp4'
  - 10 FPS의 MP4 포맷
  - 프레임별 진행 상황 표시
  - 전체 궤적의 시간적 진행 표현

## 좌표계 및 스케일

### 1. 표시 영역
```python
plt.xlim(-14, 36)
plt.ylim(-9, 26)
```
- 모든 궤적이 충분히 표시될 수 있는 범위 설정
- 축 레이블은 최소화하여 시각적 깔끔함 유지

### 2. 크기 및 스타일
- 도표 크기: 10x7 인치
- 선 굵기: 관측=2, 예측=1
- KDE 투명도: 0.3

## 테스트 데이터 생성

### 1. 기본 파라미터
```python
batch_size = 1
seq_len = 8
obs_len = 4
pred_len = 4
num_peds = 5
```

### 2. 데이터 특성
- 랜덤한 초기 위치와 움직임
- 정규 분포를 따르는 노이즈 추가
- 실제 상황을 모사하기 위한 적절한 스케일 적용

## 향후 개선 사항

1. **그룹 동적 변화**:
   - 시간에 따른 그룹 변화 추적
   - 그룹 병합/분할 시각화

2. **상호작용 시각화**:
   - 그룹 간 상호작용 표시
   - 충돌 회피 행동 강조

3. **성능 최적화**:
   - 대규모 데이터셋 처리
   - 실시간 시각화 지원

4. **사용자 인터페이스**:
   - 대화형 시각화 도구
   - 파라미터 실시간 조정
